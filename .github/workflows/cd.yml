name: CD

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches: [ main, master ]
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  release:
    types: [ published ]

jobs:
  # ÈÉ®ÁΩ≤Âà∞ Hugging Face Spaces (Gradio Â∫îÁî®)
  deploy-hf-spaces:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'push'
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.13"
    
    - name: Install uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
    
    - name: Install dependencies
      run: |
        uv pip install --system -e .
    
    - name: Create Hugging Face Space files
      run: |
        mkdir -p .hf_space
        # ÂàõÂª∫ app.py (Hugging Face Spaces ÂÖ•Âè£ÁÇπ)
        cat > .hf_space/app.py << 'EOF'
        """
        Deep Agent RAG System - Hugging Face Spaces ÈÉ®ÁΩ≤ÁâàÊú¨
        """
        import gradio as gr
        from deep_agent_rag.rag import init_rag_system
        from deep_agent_rag.graph import build_agent_graph
        from deep_agent_rag.ui import create_gradio_interface
        
        # ÂàùÂßãÂåñÁ≥ªÁªü
        rag_retriever = init_rag_system()
        graph = build_agent_graph(rag_retriever=rag_retriever)
        demo = create_gradio_interface(graph)
        
        if __name__ == "__main__":
            demo.launch()
        EOF
        
        # Â§çÂà∂È°πÁõÆ‰ª£Á†ÅÂà∞ .hf_space
        cp -r deep_agent_rag .hf_space/ 2>/dev/null || echo "‚ö†Ô∏è Could not copy deep_agent_rag directory"
        cp pyproject.toml .hf_space/ 2>/dev/null || echo "‚ö†Ô∏è Could not copy pyproject.toml"
        
        # ÂàõÂª∫ requirements.txt
        uv pip compile pyproject.toml -o .hf_space/requirements.txt 2>/dev/null || \
        uv pip list --format=freeze > .hf_space/requirements.txt || \
        echo "# Requirements will be installed from pyproject.toml" > .hf_space/requirements.txt
        
        # Â§çÂà∂ README
        cp README.md .hf_space/README.md 2>/dev/null || echo "# Deep Agent RAG System" > .hf_space/README.md
        
        # ÂàõÂª∫ .gitignoreÔºàHugging Face Spaces ÈúÄË¶ÅÔºâ
        echo "__pycache__/" > .hf_space/.gitignore
        echo "*.pyc" >> .hf_space/.gitignore
        echo ".venv/" >> .hf_space/.gitignore
        
        echo "‚úÖ Space files prepared in .hf_space/"
      continue-on-error: true
    
    - name: Install Hugging Face Hub
      run: |
        uv pip install --system huggingface_hub
      continue-on-error: true
    
    - name: Deploy to Hugging Face Spaces
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
        HF_USERNAME: ${{ secrets.HF_USERNAME }}
        HF_SPACE_NAME: ${{ secrets.HF_SPACE_NAME || 'deep-agent-rag' }}
      run: |
        if [ -z "$HF_TOKEN" ] || [ -z "$HF_USERNAME" ]; then
          echo "‚ö†Ô∏è Hugging Face credentials not set, skipping deployment"
          echo "üí° To enable deployment, set HF_TOKEN and HF_USERNAME secrets in GitHub"
          exit 0
        fi
        
        SPACE_ID="$HF_USERNAME/$HF_SPACE_NAME"
        echo "üöÄ Deploying to Hugging Face Space: $SPACE_ID"
        
        # ‰ΩøÁî® Python ËÑöÊú¨ÈÉ®ÁΩ≤
        python << 'PYTHON_SCRIPT'
        import os
        from huggingface_hub import HfApi, create_repo
        from pathlib import Path
        
        token = os.environ.get("HF_TOKEN")
        username = os.environ.get("HF_USERNAME")
        space_name = os.environ.get("HF_SPACE_NAME", "deep-agent-rag")
        space_id = f"{username}/{space_name}"
        
        if not token or not username:
            print("‚ùå Missing HF_TOKEN or HF_USERNAME")
            exit(1)
        
        api = HfApi(token=token)
        
        # ÂàõÂª∫ SpaceÔºàÂ¶ÇÊûú‰∏çÂ≠òÂú®Ôºâ
        try:
            create_repo(
                repo_id=space_id,
                repo_type="space",
                space_sdk="gradio",
                token=token,
                exist_ok=True
            )
            print(f"‚úÖ Space created/verified: {space_id}")
        except Exception as e:
            print(f"‚ö†Ô∏è Space creation check: {e}")
            # ÁªßÁª≠Â∞ùËØï‰∏ä‰º†ÔºåÂèØËÉΩ Space Â∑≤Â≠òÂú®
        
        # ‰∏ä‰º†Êñá‰ª∂
        hf_space_dir = Path(".hf_space")
        if not hf_space_dir.exists():
            print("‚ùå .hf_space directory not found!")
            exit(1)
        
        try:
            print(f"üì§ Uploading files from .hf_space/ to {space_id}...")
            api.upload_folder(
                folder_path=str(hf_space_dir),
                repo_id=space_id,
                repo_type="space",
                token=token,
                commit_message=f"Auto-deploy from GitHub Actions - {os.environ.get('GITHUB_SHA', 'unknown')[:7]}"
            )
            print(f"‚úÖ Deployment successful!")
            print(f"üåê Your app is available at: https://huggingface.co/spaces/{space_id}")
            print(f"üìä View logs at: https://huggingface.co/spaces/{space_id}/logs")
        except Exception as e:
            print(f"‚ùå Upload failed: {e}")
            import traceback
            traceback.print_exc()
            exit(1)
        PYTHON_SCRIPT
      continue-on-error: true


