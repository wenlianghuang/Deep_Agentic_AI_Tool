# Google Maps API 整合說明

本系統已整合 Google Maps API，為行事曆事件提供智能地點驗證、標準化和交通時間計算功能。

## 🎯 功能特色

### 1. **地點驗證與標準化**
- 自動驗證地址是否存在
- 將模糊或不完整的地址轉換為標準格式
- 獲取準確的座標位置

### 2. **交通時間計算**
- 自動計算從您的預設位置（家/辦公室）到事件地點的交通時間
- 根據事件時間智能計算建議出發時間
- 提供距離和預計交通時間資訊

### 3. **智能建議**
- 在創建行事曆事件時自動顯示地點驗證結果
- 提供交通時間和建議出發時間
- 如果地址驗證失敗，會顯示錯誤訊息

## 📋 設置步驟

### 1. 獲取 Google Maps API Key

1. 前往 [Google Cloud Console](https://console.cloud.google.com/)
2. 創建或選擇一個專案
3. 啟用以下 API：
   - **Geocoding API**（用於地址驗證和標準化）
   - **Directions API**（用於計算交通時間和路線）
   - **Distance Matrix API**（可選，用於更精確的交通時間計算）
4. 創建 API Key：
   - 進入「API 和服務」>「憑證」
   - 點擊「建立憑證」>「API 金鑰」
   - 複製生成的 API Key

### 2. 配置環境變數

在專案根目錄的 `.env` 文件中添加以下配置：

```env
# Google Maps API Key（必需）
NORMAL_GOOGLE_MAPS_API_KEY=your_api_key_here

# 用戶常用位置（可選，但建議設置以啟用交通時間計算）
USER_HOME_ADDRESS=台北市信義區信義路五段7號
USER_OFFICE_ADDRESS=台北市大安區敦化南路二段216號
```

**注意：**
- `NORMAL_GOOGLE_MAPS_API_KEY` 是必需的，沒有它地點驗證功能將無法使用
- `USER_HOME_ADDRESS` 和 `USER_OFFICE_ADDRESS` 是可選的，但建議至少設置一個
- 如果設置了常用位置，系統會優先使用 `USER_OFFICE_ADDRESS`，如果沒有則使用 `USER_HOME_ADDRESS`
- 地址可以是任何 Google Maps 能識別的格式（例如："台北101"、"台北市信義區信義路五段7號" 等）

### 3. 限制 API Key 使用（建議）

為了安全起見，建議在 Google Cloud Console 中限制 API Key 的使用：

1. 進入「API 和服務」>「憑證」
2. 點擊您的 API Key
3. 在「API 限制」中，選擇「限制金鑰」
4. 只選擇以下 API：
   - Geocoding API
   - Directions API
   - Distance Matrix API（如果啟用）
5. 在「應用程式限制」中，可以選擇「HTTP 參照網址」或「IP 位址」來進一步限制

## 🚀 使用方法

### 在行事曆事件中使用

1. **創建行事曆事件時自動驗證**
   - 在輸入事件提示時，包含地點資訊（例如："明天下午2點會議，地點在台北101"）
   - 系統會自動：
     - 驗證地址是否存在
     - 將地址標準化為完整格式
     - 計算從您的預設位置到該地點的交通時間
     - 根據事件時間建議出發時間

2. **查看地點資訊**
   - 在生成事件草稿後，狀態訊息中會顯示：
     - ✅ 地址驗證結果
     - 📍 交通時間和距離
     - ⏰ 建議出發時間（如果提供了事件時間）

3. **地址驗證失敗處理**
   - 如果地址無法驗證，系統會：
     - 保留原始地址
     - 顯示錯誤訊息
     - 仍然允許創建事件（使用原始地址）

## 💡 使用範例

### 範例 1：基本使用

**輸入提示：**
```
明天下午2點團隊會議，討論項目進度，地點在台北101
```

**系統處理：**
1. 驗證並標準化地址："台北市信義區市府路45號（台北101）"
2. 計算交通時間：從您的辦公室到台北101，預計需要 25 分鐘（12.5 公里）
3. 建議出發時間：2026-01-26 13:35（提前 10 分鐘到達）

**顯示結果：**
```
✅ 地址已驗證：台北市信義區市府路45號（台北101）
📍 從您的預設位置出發，預計需要 25 分鐘（12.5 公里）
⏰ 建議出發時間：2026-01-26 13:35
```

### 範例 2：模糊地址

**輸入提示：**
```
後天上午10點客戶拜訪，地點在信義區的咖啡廳
```

**系統處理：**
1. 如果地址太模糊，可能無法精確驗證
2. 系統會顯示警告，但仍允許創建事件

### 範例 3：未設置預設位置

**輸入提示：**
```
明天下午3點會議，地點在台北車站
```

**系統處理：**
1. 驗證並標準化地址："台北市中正區北平西路3號（台北車站）"
2. 由於未設置預設位置，無法計算交通時間
3. 顯示提示訊息，建議設置 `USER_HOME_ADDRESS` 或 `USER_OFFICE_ADDRESS`

## ⚠️ 注意事項

1. **API 配額限制**
   - Google Maps API 有免費配額限制
   - Geocoding API：每月前 40,000 次請求免費
   - Directions API：每月前 40,000 次請求免費
   - 超過配額後會產生費用，請注意使用量

2. **地址格式**
   - 系統支援多種地址格式（中文、英文、地標名稱等）
   - 建議使用完整的地址以獲得最佳結果
   - 模糊地址（如「附近的咖啡廳」）可能無法驗證

3. **交通時間計算**
   - 交通時間基於當前或指定時間的交通狀況
   - 實際交通時間可能因交通狀況變化而有所不同
   - 系統會自動添加 10 分鐘緩衝時間

4. **錯誤處理**
   - 如果 Google Maps API 調用失敗，系統會：
     - 記錄錯誤訊息
     - 保留原始地址
     - 仍然允許創建事件
   - 不會因為 API 錯誤而阻止事件創建

## 🔧 技術細節

### 使用的 Google Maps API

1. **Geocoding API**
   - 用於地址驗證和標準化
   - 將地址轉換為座標和標準格式

2. **Directions API**
   - 用於計算交通時間和路線
   - 支援多種交通方式（開車、步行、大眾運輸、騎車）

### 整合位置

- **工具模組**：`deep_agent_rag/tools/googlemaps_tool.py`
- **Agent 整合**：`deep_agent_rag/agents/calendar_agent.py`
- **配置**：`deep_agent_rag/config.py`

## 📝 未來擴展

未來可能會添加以下功能：

1. **地點智能推薦**：根據事件類型推薦合適的地點
2. **多點路線優化**：優化一天中多個會議的順序
3. **實時交通監控**：在事件前自動檢查交通狀況
4. **地點資訊豐富化**：顯示營業時間、評分、照片等資訊

## ✅ 驗證設置

設置完成後，可以通過以下方式驗證：

1. 在 Gradio UI 中切換到「📅 Calendar Tool」標籤
2. 輸入包含地點的事件提示（例如："明天下午2點會議，地點在台北101"）
3. 點擊「📝 生成事件草稿」
4. 查看狀態訊息中是否顯示地點驗證和交通時間資訊

如果看到類似以下的訊息，說明設置成功：

```
✅ 地址已驗證：台北市信義區市府路45號（台北101）
📍 從您的預設位置出發，預計需要 25 分鐘（12.5 公里）
⏰ 建議出發時間：2026-01-26 13:35
```

