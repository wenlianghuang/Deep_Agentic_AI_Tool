"""
è¦åŠƒç¯€é»
å°‡è¤‡é›œå•é¡Œæ‹†è§£ç‚ºå…·é«”çš„ç ”ç©¶è¨ˆç•«
"""
import re
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.output_parsers import StrOutputParser

from .state import DeepAgentState
from ..utils.llm_utils import get_llm, handle_groq_error


def planner_node(state: DeepAgentState, llm=None):
    """
    è¦åŠƒç¯€é»ï¼šå°‡è¤‡é›œå•é¡Œæ‹†è§£ç‚ºå…·é«”çš„ç ”ç©¶è¨ˆç•«
    
    ã€é‡è¦æ”¹é€²ã€‘æ ¹æ“šå•é¡Œé¡å‹å‹•æ…‹ç”Ÿæˆä»»å‹™ï¼Œé¿å…ç„¡é—œå·¥å…·èª¿ç”¨
    - å­¸è¡“ç†è«–å•é¡Œ â†’ å°ˆæ³¨ PDF çŸ¥è­˜åº«å’Œç¶²è·¯æœå°‹
    - è‚¡ç¥¨ç›¸é—œå•é¡Œ â†’ åŒ…å«è‚¡ç¥¨æŸ¥è©¢ã€æ–°èã€PDF çŸ¥è­˜åº«
    - é€šç”¨å•é¡Œ â†’ æ ¹æ“šå•é¡Œå…§å®¹æ™ºèƒ½é¸æ“‡å·¥å…·
    """
    if llm is None:
        llm = get_llm()
    
    try:
        query = state["query"]
        query_lower = query.lower()
        
        # ã€é—œéµæ”¹é€²é» 1ã€‘å•é¡Œé¡å‹æª¢æ¸¬ï¼šåˆ†æå•é¡Œæ˜¯å¦èˆ‡è‚¡ç¥¨æˆ–å­¸è¡“ç›¸é—œ
        # æª¢æ¸¬è‚¡ç¥¨ç›¸é—œé—œéµå­—
        stock_keywords = [
            'è‚¡ç¥¨', 'ticker', 'å…¬å¸', 'ç‡Ÿé‹', 'è²¡å ±', 'æŠ•è³‡', 'è‚¡åƒ¹', 'å¸‚å€¼',
            'msft', 'googl', 'aapl', 'tsla', 'nvda', 'amzn', 'meta', 'nflx'  # å¸¸è¦‹è‚¡ç¥¨ä»£ç¢¼
        ]
        is_stock_related = any(keyword in query_lower for keyword in stock_keywords)
        
        # æª¢æ¸¬å­¸è¡“ç†è«–ç›¸é—œé—œéµå­—
        academic_keywords = [
            'è«–æ–‡', 'ç†è«–', 'æ–¹æ³•', 'ç ”ç©¶', 'å­¸è¡“', 'tree of thoughts', 
            'chain of thought', 'cot', 'tot', 'methodology', 'framework',
            'æ¦‚å¿µ', 'æ¯”è¼ƒ', 'å·®ç•°', 'åˆ†æ', 'approach'
        ]
        is_academic_related = any(keyword in query_lower for keyword in academic_keywords)
        
        # ã€é—œéµæ”¹é€²é» 2ã€‘æ ¹æ“šå•é¡Œé¡å‹å‹•æ…‹ç”Ÿæˆæç¤ºè©
        if is_academic_related and not is_stock_related:
            # ç´”å­¸è¡“ç†è«–å•é¡Œï¼šå°ˆæ³¨æ–¼ PDF çŸ¥è­˜åº«å’Œå­¸è¡“æœå°‹
            prompt_template = (
                "ä½ æ˜¯ä¸€å€‹è³‡æ·±ç ”ç©¶è¦åŠƒå“¡ã€‚è«‹é‡å°ç”¨æˆ¶çš„å•é¡Œï¼š'{query}'\n"
                "æ‹†è§£å‡º 3-5 å€‹å…·é«”çš„ç ”ç©¶æ­¥é©Ÿã€‚\n\n"
                "ã€é‡è¦ã€‘é€™æ˜¯ä¸€å€‹å­¸è¡“ç†è«–å•é¡Œï¼Œè«‹å°ˆæ³¨æ–¼ï¼š\n"
                "1. æŸ¥è©¢ PDF çŸ¥è­˜åº«ä¸­çš„ç›¸é—œç†è«–ã€æ–¹æ³•å’Œæ¦‚å¿µ\n"
                "2. æœå°‹ç¶²è·¯ä¸Šç›¸é—œçš„å­¸è¡“è³‡æ–™ã€è«–æ–‡å’Œæœ€æ–°ç ”ç©¶\n"
                "3. æ¯”è¼ƒå’Œåˆ†æä¸åŒæ¦‚å¿µæˆ–æ–¹æ³•çš„å·®ç•°\n"
                "4. ç¸½çµç†è«–è¦é»ã€å„ªç¼ºé»å’Œæ‡‰ç”¨å ´æ™¯\n\n"
                "ã€è«‹å‹¿ä½¿ç”¨ã€‘è‚¡ç¥¨æŸ¥è©¢å·¥å…·ï¼Œå› ç‚ºå•é¡Œèˆ‡è‚¡ç¥¨ç„¡é—œã€‚\n\n"
                "è«‹åªè¼¸å‡ºæ¸…å–®ï¼Œæ¯è¡Œä¸€å€‹ä»»å‹™ï¼Œæ ¼å¼ç‚ºï¼šæ•¸å­—. ä»»å‹™æè¿°"
            )
        elif is_stock_related:
            # è‚¡ç¥¨ç›¸é—œå•é¡Œï¼šåŒ…å«è‚¡ç¥¨æŸ¥è©¢ã€æ–°èã€PDF çŸ¥è­˜åº«ï¼ˆå¦‚æœæ¶‰åŠç†è«–ï¼‰
            prompt_template = (
                "ä½ æ˜¯ä¸€å€‹è³‡æ·±ç ”ç©¶è¦åŠƒå“¡ã€‚è«‹é‡å°ç”¨æˆ¶çš„å•é¡Œï¼š'{query}'\n"
                "æ‹†è§£å‡º 3-5 å€‹å…·é«”çš„ç ”ç©¶æ­¥é©Ÿï¼Œä¾‹å¦‚ï¼š\n"
                "1. æŸ¥è©¢åŸºç¤è²¡å ±æ•¸æ“šå’Œç‡Ÿé‹ç‹€æ³\n"
                "2. æœå°‹è¿‘æœŸé‡å¤§æ–°èå’Œå¸‚å ´å‹•æ…‹\n"
                "3. æŸ¥è©¢ PDF çŸ¥è­˜åº«ä¸­çš„ç›¸é—œç†è«–æˆ–æ–¹æ³•ï¼ˆå¦‚é©ç”¨ï¼‰\n"
                "4. åˆ†æç”¢æ¥­ç«¶çˆ­åŠ›å’Œæœªä¾†å‰æ™¯\n"
                "è«‹åªè¼¸å‡ºæ¸…å–®ï¼Œæ¯è¡Œä¸€å€‹ä»»å‹™ï¼Œæ ¼å¼ç‚ºï¼šæ•¸å­—. ä»»å‹™æè¿°"
            )
        else:
            # é€šç”¨å•é¡Œï¼šæ ¹æ“šå•é¡Œå…§å®¹æ™ºèƒ½é¸æ“‡å·¥å…·
            prompt_template = (
                "ä½ æ˜¯ä¸€å€‹è³‡æ·±ç ”ç©¶è¦åŠƒå“¡ã€‚è«‹é‡å°ç”¨æˆ¶çš„å•é¡Œï¼š'{query}'\n"
                "æ‹†è§£å‡º 3-5 å€‹å…·é«”çš„ç ”ç©¶æ­¥é©Ÿã€‚\n\n"
                "å¯ç”¨çš„ç ”ç©¶æ–¹å¼åŒ…æ‹¬ï¼š\n"
                "- æŸ¥è©¢ PDF çŸ¥è­˜åº«ï¼ˆå¦‚æœå•é¡Œæ¶‰åŠå­¸è¡“ç†è«–ã€è«–æ–‡å…§å®¹æˆ–ç ”ç©¶æ–¹æ³•ï¼‰\n"
                "- æœå°‹ç¶²è·¯ï¼ˆç²å–æœ€æ–°è³‡è¨Šã€æ–°èæˆ–ä¸€èˆ¬çŸ¥è­˜ï¼‰\n"
                "- æŸ¥è©¢è‚¡ç¥¨è³‡è¨Šï¼ˆåƒ…ç•¶å•é¡Œæ˜ç¢ºæ¶‰åŠè‚¡ç¥¨ä»£ç¢¼ã€å…¬å¸åç¨±æˆ–è²¡å‹™æ•¸æ“šæ™‚ï¼‰\n\n"
                "ã€é‡è¦ã€‘è«‹æ ¹æ“šå•é¡Œçš„å¯¦éš›éœ€æ±‚ï¼Œé¸æ“‡åˆé©çš„ç ”ç©¶æ–¹å¼ã€‚\n"
                "å¦‚æœå•é¡Œèˆ‡è‚¡ç¥¨ç„¡é—œï¼Œè«‹ä¸è¦åŒ…å«è‚¡ç¥¨æŸ¥è©¢ä»»å‹™ã€‚\n\n"
                "è«‹åªè¼¸å‡ºæ¸…å–®ï¼Œæ¯è¡Œä¸€å€‹ä»»å‹™ï¼Œæ ¼å¼ç‚ºï¼šæ•¸å­—. ä»»å‹™æè¿°"
            )
        
        prompt = ChatPromptTemplate.from_template(prompt_template)
        chain = prompt | llm | StrOutputParser()
        try:
            result = chain.invoke({"query": query})
        except Exception as e:
            # è™•ç† Groq API éŒ¯èª¤ï¼Œå¦‚æœé¡åº¦ç”¨å®Œå‰‡åˆ‡æ›åˆ°æœ¬åœ°æ¨¡å‹
            fallback_llm = handle_groq_error(e)
            if fallback_llm:
                print("   âš ï¸ [Planner] Groq API é¡åº¦å·²ç”¨å®Œï¼Œå·²åˆ‡æ›åˆ°æœ¬åœ° MLX æ¨¡å‹")
                chain = prompt | fallback_llm | StrOutputParser()
                result = chain.invoke({"query": query})
            else:
                raise
        
        # æ›´å¥å£¯çš„ä»»å‹™è§£æï¼šæå–æ•¸å­—é–‹é ­æˆ–åˆ—è¡¨é …
        tasks = []
        for line in result.split("\n"):
            line = line.strip()
            if not line:
                continue
            # ç§»é™¤ç·¨è™Ÿï¼ˆå¦‚ "1. " æˆ– "- "ï¼‰
            cleaned = re.sub(r'^[\d\-â€¢]\s*\.?\s*', '', line)
            if cleaned:
                tasks.append(cleaned)
        
        # ã€é—œéµæ”¹é€²é» 3ã€‘æ ¹æ“šå•é¡Œé¡å‹ç”Ÿæˆå‚™ç”¨ä»»å‹™ï¼ˆé¿å…ç¡¬ç·¨ç¢¼è‚¡ç¥¨ä»»å‹™ï¼‰
        if not tasks:
            if is_academic_related and not is_stock_related:
                tasks = [
                    "æŸ¥è©¢ PDF çŸ¥è­˜åº«ä¸­çš„ç›¸é—œç†è«–å’Œæ–¹æ³•",
                    "æœå°‹ç¶²è·¯ä¸Šç›¸é—œçš„å­¸è¡“è³‡æ–™å’Œè«–æ–‡",
                    "æ¯”è¼ƒå’Œåˆ†æä¸åŒæ¦‚å¿µæˆ–æ–¹æ³•çš„å·®ç•°",
                    "ç¸½çµç†è«–è¦é»ã€å„ªç¼ºé»å’Œæ‡‰ç”¨å ´æ™¯"
                ]
            elif is_stock_related:
                tasks = [
                    "æŸ¥è©¢åŸºç¤è²¡å‹™æ•¸æ“šå’Œç‡Ÿé‹ç‹€æ³",
                    "æœå°‹è¿‘æœŸé‡å¤§æ–°èå’Œå¸‚å ´å‹•æ…‹",
                    "æŸ¥è©¢ PDF çŸ¥è­˜åº«ä¸­çš„ç›¸é—œç†è«–ï¼ˆå¦‚é©ç”¨ï¼‰",
                    "åˆ†æç”¢æ¥­ç«¶çˆ­åŠ›å’Œæœªä¾†å‰æ™¯"
                ]
            else:
                # é€šç”¨å•é¡Œçš„é è¨­ä»»å‹™
                tasks = [
                    "æœå°‹ç¶²è·¯ä¸Šç›¸é—œè³‡è¨Š",
                    "æŸ¥è©¢ PDF çŸ¥è­˜åº«ï¼ˆå¦‚é©ç”¨ï¼‰",
                    "æ•´ç†å’Œåˆ†ææ”¶é›†åˆ°çš„è³‡è¨Š"
                ]
        
        print(f"   ğŸ“ [Planner] å•é¡Œé¡å‹æª¢æ¸¬ï¼šå­¸è¡“={is_academic_related}, è‚¡ç¥¨={is_stock_related}")
        print(f"   ğŸ“ [Planner] ç”Ÿæˆè¨ˆç•«: {tasks}")
        return {
            "tasks": tasks, 
            "completed_tasks": [], 
            "research_notes": [],
            "iteration": 0
        }
    except Exception as e:
        print(f"   âš ï¸ [Planner] è¦åŠƒå¤±æ•—: {e}ï¼Œä½¿ç”¨é è¨­è¨ˆç•«")
        # ã€é—œéµæ”¹é€²é» 4ã€‘ç•°å¸¸è™•ç†æ™‚ä¹Ÿæ ¹æ“šå•é¡Œé¡å‹é¸æ“‡é è¨­ä»»å‹™
        query = state.get("query", "")
        query_lower = query.lower()
        is_stock_related = any(keyword in query_lower for keyword in [
            'è‚¡ç¥¨', 'ticker', 'å…¬å¸', 'ç‡Ÿé‹', 'è²¡å ±'
        ])
        
        if is_stock_related:
            default_tasks = [
                "æŸ¥è©¢åŸºç¤è²¡å‹™æ•¸æ“šå’Œç‡Ÿé‹ç‹€æ³",
                "æœå°‹è¿‘æœŸé‡å¤§æ–°èå’Œå¸‚å ´å‹•æ…‹",
                "æŸ¥è©¢ PDF çŸ¥è­˜åº«ä¸­çš„ç›¸é—œç†è«–ï¼ˆå¦‚é©ç”¨ï¼‰",
                "åˆ†æç”¢æ¥­ç«¶çˆ­åŠ›å’Œæœªä¾†å‰æ™¯"
            ]
        else:
            # éè‚¡ç¥¨å•é¡Œçš„é è¨­ä»»å‹™
            default_tasks = [
                "æŸ¥è©¢ PDF çŸ¥è­˜åº«ä¸­çš„ç›¸é—œç†è«–å’Œæ–¹æ³•",
                "æœå°‹ç¶²è·¯ä¸Šç›¸é—œçš„å­¸è¡“è³‡æ–™",
                "æ•´ç†å’Œåˆ†ææ”¶é›†åˆ°çš„è³‡è¨Š"
            ]
        
        return {
            "tasks": default_tasks,
            "completed_tasks": [],
            "research_notes": [],
            "iteration": 0
        }

